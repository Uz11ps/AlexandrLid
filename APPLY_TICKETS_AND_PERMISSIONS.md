# Применение системы тикетов и прав доступа

## Шаги для применения изменений

### 1. Применить миграцию базы данных

```bash
cd /opt/AlexandrLid

# Скопировать файл миграции в контейнер PostgreSQL
docker compose cp init_tickets_and_permissions.sql postgres:/tmp/

# Применить миграцию
docker compose exec -T postgres psql -U postgres -d telegram_bot_db -f /tmp/init_tickets_and_permissions.sql
```

### 2. Пересобрать и перезапустить контейнеры

```bash
cd /opt/AlexandrLid

# Получить последние изменения
git pull

# Пересобрать контейнеры без кэша
docker compose build --no-cache

# Перезапустить все сервисы
docker compose restart
```

### 3. Проверка работы

#### Проверка тикетов:
1. Откройте CRM: `https://momentumtrading.ru`
2. Войдите как администратор
3. Перейдите в раздел "Чат"
4. Создайте тикет для тестового пользователя
5. Отправьте сообщение в тикет

#### Проверка прав доступа:
1. Перейдите в раздел "Права доступа"
2. Выберите роль (например, "manager")
3. Установите/снимите права для разных разделов
4. Сохраните изменения

#### Проверка Telegram бота:
1. Отправьте команду `/ticket` в бот
2. Отправьте текстовое сообщение (оно должно быть добавлено в тикет)
3. В CRM проверьте, что сообщение появилось в тикете

## Что было реализовано

### Система тикетов:
- ✅ Таблицы БД для тикетов и сообщений
- ✅ API endpoints для работы с тикетами
- ✅ Страница "Чат" в CRM с перепиской
- ✅ Интеграция с Telegram ботом
- ✅ Команды `/ticket` и `/ticket_new` в боте
- ✅ Автоматическая обработка сообщений пользователей в тикеты

### Система прав доступа:
- ✅ Таблицы БД для прав, прав ролей и прав пользователей
- ✅ API endpoints для управления правами
- ✅ Страница "Права доступа" в CRM
- ✅ Управление правами по ролям
- ✅ Управление правами по пользователям
- ✅ Middleware для проверки прав (готов к использованию)

### Формы создания в вебке:
- ✅ Форма создания рассылок
- ✅ Форма создания розыгрышей
- ✅ Форма создания автоворонок
- ✅ Форма создания лид-магнитов

## Структура прав доступа

### Ресурсы:
- `leads` - Лиды
- `students` - Студенты
- `deals` - Сделки
- `products` - Продукты
- `tasks` - Задачи
- `analytics` - Аналитика
- `templates` - Шаблоны
- `documents` - Документы
- `bot_admin` - Админка бота
- `chat` - Чат/Тикеты
- `permissions` - Права доступа

### Действия:
- `read` - Просмотр
- `create` - Создание
- `update` - Редактирование
- `delete` - Удаление

### Роли по умолчанию:
- **admin** - все права
- **manager** - права на лиды, студентов, сделки, задачи, чат, шаблоны, документы (read, create, update)
- **marketer** - права на лиды, аналитику, шаблоны, админку бота (read, create, update)
- **accountant** - права на просмотр студентов, сделок, аналитики

## Использование middleware для проверки прав

В роутах backend можно использовать:

```javascript
import { requirePermission } from './routes/permissions.js';

router.get('/some-route', requirePermission('leads', 'read'), async (req, res) => {
  // Ваш код
});
```

## Возможные проблемы и решения

### Проблема: Миграция не применяется
**Решение**: Проверьте, что контейнер PostgreSQL запущен:
```bash
docker compose ps postgres
```

### Проблема: Тикеты не создаются
**Решение**: Проверьте логи backend:
```bash
docker compose logs crm-backend | tail -50
```

### Проблема: Сообщения не отправляются в Telegram
**Решение**: Проверьте, что `BOT_TOKEN` установлен в `.env` файле backend:
```bash
docker compose exec crm-backend printenv BOT_TOKEN
```

